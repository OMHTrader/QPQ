<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Investor ↔ Company Map</title>

  <!-- Leaflet (no SRI so it won’t be blocked) -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    :root{
      --bg:#0f172a; --panel:#111827cc; --text:#e5e7eb; --accent:#60a5fa;
      --blue:#3b82f6; --red:#ef4444; --link:#f59e0b;
      /* height of the fixed instruction banner */
      --bannerH: 46px;
    }
    html,body{height:100%;margin:0}
    body{
      background:var(--bg); color:var(--text);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,Helvetica Neue,Arial;
      font-size:20px; line-height:1.45;
    }

    /* Forever instruction banner at very top */
    .instruction-banner{
      position:fixed; top:0; left:0; right:0; z-index:2000;
      background:var(--panel);
      color:var(--text);
      border-bottom:1px solid rgba(255,255,255,0.08);
      backdrop-filter:blur(6px); -webkit-backdrop-filter:blur(6px);
      text-align:center; font-weight:700; letter-spacing:.2px;
      padding:10px 12px; line-height:26px; user-select:none;
    }

    /* Map occupies full height below the banner */
    #map{height:calc(100vh - var(--bannerH)); width:100%; margin-top:var(--bannerH);}

    .banner{
      position:fixed; left:12px; top:calc(12px + var(--bannerH)); z-index:1100;
      background:#b91c1ccc;color:white;border:1px solid #7f1d1d;border-radius:10px;
      padding:8px 12px;display:none;max-width:60ch
    }
    .ok{background:#065f4677;border-color:#065f46;display:none}

    .control-panel{
      position:fixed; z-index:1000; top:calc(16px + var(--bannerH)); right:12px;
      background:var(--panel); backdrop-filter:blur(6px);
      border:1px solid #1f2937; border-radius:16px; padding:12px 14px; min-width:360px;
      box-shadow:0 8px 24px rgba(0,0,0,.35);
    }
    .control-panel h2{font-size:1rem; margin:0 0 8px; font-weight:700}
    .row{display:flex; align-items:center; gap:10px; margin:8px 0}
    .row button,.row select{ padding:8px 12px; border-radius:10px; border:1px solid #374151;
      background:#0b1220; color:var(--text); font-size:.95rem; cursor:pointer; }
    .row label{font-size:.95rem; opacity:.9}
    .footnote{font-size:.85rem; opacity:.75; margin-top:8px}
    .legend{ position:fixed; z-index:1000; bottom:12px; left:12px;
      background:var(--panel); border:1px solid #1f2937; border-radius:12px; padding:10px 12px; font-size:.95rem; }
    .legend .swatch{display:inline-block; width:12px; height:12px; border-radius:50%; margin-right:6px}
    .legend .item{margin-right:12px; white-space:nowrap}
    .leaflet-container{background:#0b1020}
    .leaflet-control-attribution{background:rgba(17,24,39,.6); color:#cbd5e1; font-size:.8rem}
    .leaflet-popup-content{color:#0b1220; font-size:.95rem}
    a{color:var(--accent)}
    .svg-icon{filter:drop-shadow(0 2px 4px rgba(0,0,0,.6))}
    code.inline{background:#0b1220;padding:2px 6px;border-radius:6px;border:1px solid #374151}

    /* Details/summary collapse styling */
    .control-panel details { position: relative; }
    .control-panel summary { list-style: none; display:flex; align-items:center; gap:10px; cursor:pointer; }
    .control-panel summary::-webkit-details-marker { display:none; } /* hide default triangle */
    .summary-bar { background:#0b1220; border:1px solid #374151; border-radius:10px; padding:8px 10px; }
    .summary-bar .title { font-weight:700; font-size:1rem; }
    .summary-bar .chev { margin-left:auto; opacity:.8; }
    .summary-bar select { flex:1 1 auto; min-width:160px; }

    /* When collapsed, only the summary row (with the ticker) is visible */
    #panelToggle:not([open]) .row,
    #panelToggle:not([open]) details,
    #panelToggle:not([open]) .footnote,
    #panelToggle:not([open]) #stats,
    #panelToggle:not([open]) #companyMeta { display:none !important; }
  </style>
</head>
<body>
  <!-- Forever instruction (pinned) -->
  <div class="instruction-banner" role="note" aria-live="polite">
    Click on the circles and arcs
  </div>

  <div id="err" class="banner"></div>
  <div id="ok" class="banner ok"></div>

  <div class="control-panel collapsed" id="controls">
    <details id="panelToggle" open>
      <summary class="summary-bar" aria-label="Toggle panel">
        <span class="title">Company Focus</span>
        <select id="companySelect" aria-label="Select company"></select>
        <span class="chev" aria-hidden="true">▾</span>
      </summary>

      <div class="row">
        <button id="prevBtn" title="Previous company">◀</button>
        <button id="nextBtn" title="Next company">▶</button>
      </div>

      <div class="row">
        <label><input type="checkbox" id="showAllLinks" /> Show all arcs</label>
      </div>

      <details style="margin-top:4px">
        <summary style="cursor:pointer; opacity:.9">Instructions</summary>
        <div style="margin-top:6px; font-size:.9rem; opacity:.9">
          • Use ◀ ▶ or the dropdown to change the focused company.<br>
          • When “Show all arcs” is off, only the focused company and its investors are shown.<br>
          • Click any dot to see details. Investor, Company, ★ White House, ▲ Mar-a-Lago.<br>
          • Click any arc to see the relationship.
        </div>
      </details>

      <div id="stats" style="font-size:.9rem;opacity:.9;margin-top:6px"></div>
      <div id="companyMeta" style="font-size:.95rem; line-height:1.5; opacity:.95;"></div>
      <div class="footnote">Data: <code class="inline">const DATA = { ... }</code> (embedded below)</div>
    </details>
  </div>

  <div class="legend">
    <span class="item"><span class="swatch" style="background:var(--blue)"></span>Company</span>
    <span class="item"><span class="swatch" style="background:var(--red)"></span>Investor</span>
    <span class="item">▲ Mar-a-Lago</span>
    <span class="item">★ White House</span>
  </div>

  <div id="map"></div>

  <script>
  // ---------- Inline data with baked-in coordinates ----------
  const DATA = {
    companies: [
      { id:"NG", ticker:"NG", name:"NOVAGOLD RESOURCES INC.", desc:"A goldmine in Alaska", address:"Crooked Creek, AK", lat:61.5930, lng:-158.1160, qpq:"Investors are likely going to use Trump to get federal funds to build the mine, relax federal restrictions on building the mine, and/or use the potential of the mine as a pump and dump." },
      { id:"RDW", ticker:"RDW", name:"REDWIRE CORPORATION", desc:"Defense Contractor", address:"Jacksonville, FL", lat:30.2055, lng:-81.5829, qpq:"Investors are likely looking to get defense contracts around the Golden Dome." },
      { id:"QXO", ticker:"QXO", name:"QXO, INC.", desc:"Construction Companies", address:"Miami, FL", lat:25.7617, lng:-80.1918, qpq:"QXO is an investment vehicle with money coming in from foreign companies." },
      { id:"BKKT", ticker:"BKKT", name:"BKKT", desc:"Crypto Treasury", address:"Alpharetta, GA", lat:34.0754, lng:-84.2941, qpq:"Bakkt is looking to expand as a crypto treasurer listing on multiple exchanges in foreign countries. Likely to see little regulation." },
      { id:"WOLF", ticker:"WOLF", name:"Wolfspeed", desc:"Semiconductor", address:"Durham, NC", lat:35.9940, lng:-78.8986, qpq:"An American only semiconductor manufacturer. Strong potential for US Gov Investment like INTC." },
      { id:"ALTS", ticker:"ALTS", name:"ALTS", desc:"Crypto Treasury (WLFI)", address:"Miami Beach, FL", lat:25.7907, lng:-80.1300, qpq:"The Company buys WLFI, one of Trump's crypto currencies with money from issuing stock." },
      { id:"PSQH", ticker:"PSQH", name:"PSQ Holdings (PublicSquare)", desc:"Conservative Marketplace", address:"West Palm Beach, FL", lat:26.7153, lng:-80.0534, qpq:"Could see favorable promotions of marketplace goods." },
      { id:"PLTR", ticker:"PLTR", name:"Palantir Technologies", desc:"Defense Contractor", address:"Denver, CO", lat:39.7392, lng:-104.9903, qpq:"Provides major data analytics and defense contracting for the Trump administration in both terms." },
      { id:"TSLA", ticker:"TSLA", name:"Tesla, Inc.", desc:"Car Company", address:"Austin, TX", lat:30.2672, lng:-97.7431, qpq:"Provides major data analytics and defense contracting for Trump's presidency." },
      { id:"META", ticker:"META", name:"Meta Platforms", desc:"Media", address:"Menlo Park, CA", lat:37.4549, lng:-122.1817, qpq:"Provides major data analytics and message outreach for the Trump campaign" },
      { id:"ROIV", ticker:"ROIV", name:"Roivant Sciences", desc:"Healthcare", address:"New York, NY", lat:40.7580, lng:-73.9855, qpq:"Could see special treatment by the FDA" },
      { id:"IMVT", ticker:"IMVT", name:"Immunovant, Inc.", desc:"Healthcare", address:"New York, NY", lat:40.7549, lng:-73.9840, qpq:"Could see special treatment by the FDA" },
      { id:"BZFD", ticker:"BZFD", name:"BuzzFeed, Inc.", desc:"Media", address:"New York, NY", lat:40.7400, lng:-74.0020, qpq:"Could see special treatment by the FTC" },
      { id:"RUM", ticker:"RUM", name:"Rumble Inc.", desc:"Hosts Truth Social", address:"Sarasota, FL", lat:27.3364, lng:-82.5307, qpq:"Could see special treatment by the FTC. Maybe it becomes a public broadcasting station" },
      { id:"DJT_DWAC", ticker:"DJT/DWAC", name:"Trump Media / DWAC", desc:"Crypto Treasurer", address:"Sarasota, FL", lat:27.3364, lng:-82.5307, qpq:"Could see the crypto strategic reserve initiative." },
      { id:"UMAC", ticker:"UMAC", name:"Unusual Machines, Inc.", desc:"Drones", address:"San Juan, PR", lat:18.4655, lng:-66.1057, qpq:"An American Drone manufacturer possibly set to receive government contracts." },
      { id:"HOND", ticker:"HOND", name:"HCM II Acquisition (Energy)", desc:"Energy", address:"Houston, TX", lat:29.7604, lng:-95.3698, qpq:"Recently received approval by the Energy Department as a qualified reactor company." },
      { id:"CEPO_BSTR", ticker:"CEPO/BSTR", name:"CEPO / BSTR", desc:"Crypto treasurer", address:"New York, NY", lat:40.7128, lng:-74.0060, qpq:"Could see crypto strategic reserve." },
      { id:"ABTC", ticker:"ABTC", name:"American Blockchain Corp.", desc:"Crypto Miner", address:"Las Vegas, NV", lat:36.1699, lng:-115.1398, qpq:"A miner for the strategic reserve." },
      { id:"PHM", ticker:"PHM", name:"PulteGroup, Inc.", desc:"Housing Developer", address:"Atlanta, GA", lat:33.8486, lng:-84.3733, qpq:"Could see beneficial housing regulations." }
    ],
    investors: [
      { id:"GHISALLO", name:"Ghisallo Capital Management LLC", address:"240 Newbury St, 2nd Fl, Boston, MA 02116", notes:"Trump's Secretary of Treasury Scott Bessent seeded this hedge fund.", lat:42.3490, lng:-71.0850 },
      { id:"BALYASNY", name:"Balyasny Asset Management L.P.", address:"444 W Lake St, 50th Fl, Chicago, IL 60606", notes:"Owns several companies with links to Trump and allies.", lat:41.8858, lng:-87.6394 },
      { id:"PAULSON", name:"PAULSON & CO. INC.", address:"277 Park Ave, New York, NY 10172", notes:"Economic advisor to Trump during first term.", lat:40.7577, lng:-73.9726 },
      { id:"AEI", name:"AE Industrial Partners", address:"6700 Broken Sound Pkwy NW, Ste 100, Boca Raton, FL 33487", notes:"Owner AEI has very close proximity to Mar-a-Lago.", lat:26.3948, lng:-80.1179 },
      { id:"HUDSONBAY", name:"Hudson Bay Capital Management LP", address:"28 Havemeyer Pl, 2nd Fl, Greenwich, CT 06830", notes:"Owner Sander Gerber is on Donald Trump's intelligence advisory board.", lat:41.0306, lng:-73.6286 },
      { id:"HOODRIVER", name:"Hood River Capital Management LLC", address:"2373 PGA Boulevard, Suite 200, Palm Beach Gardens, FL 33410", notes:"Owns several companies with links to Trump and allies.", lat:26.84583, lng:-80.06717 },
      { id:"PETER_CANNITO", name:"Peter Cannito", address:"8226 Philips Hwy, Ste 101, Jacksonville, FL 32256", notes:"CEO of RDW; praised the Trump administration re: Golden Dome.", lat:30.2147, lng:-81.5860 },
      { id:"CANTOR", name:"CANTOR FITZGERALD, L. P.", address:"300 Avenue of the Champions, Suite 110, Palm Beach Gardens, FL 33418", notes:"Official Palm Beach Gardens office.", lat:26.83663, lng:-80.13731 },
      { id:"AFFINITY", name:"Affinity Partners GP LP", address:"Miami, FL", notes:"Jared Kushner is the managing partner and sits on the board.", lat:25.7617, lng:-80.1918 },
      { id:"ICE", name:"Intercontinental Exchange (ICE)", address:"5660 New Northside Dr NW, 3rd Fl, Atlanta, GA 30328", notes:"Kelly Loeffler co-founded Bakkt with ICE CEO.", lat:33.9141, lng:-84.4380 },
      { id:"CITADEL", name:"Citadel Advisors LLC", address:"200 S Biscayne Blvd, Ste 3300, Miami, FL 33131", notes:"Ken Griffin is a major Trump supporter.", lat:25.7704, lng:-80.1899 },
      { id:"KELLY_LOEFFLER", name:"Kelly Loeffler", address:"Atlanta, GA", notes:"Founder/ex-CEO of Bakkt; SBA Director.", lat:33.7485, lng:-84.3915 },
      { id:"JANE_STREET", name:"JANE STREET GROUP, LLC", address:"250 Vesey St, New York, NY 10281", notes:"Largest 13F filer for DJT.", lat:40.7149, lng:-74.0151 },
      { id:"ZACH_WITIKOFF", name:"Zach Witikoff", address:"Miami Beach, FL", notes:"Board member; son of Steve Witkoff.", lat:25.7907, lng:-80.1300 },
      { id:"DONALD_TRUMP_JR", name:"Donald Trump Jr.", address:"Palm Beach, FL", notes:"Trump's son.", lat:26.7153, lng:-80.0534 },
      { id:"PETER_THIEL", name:"Peter Thiel", address:"Miami, FL", notes:"Major Trump supporter.", lat:25.7617, lng:-80.1918 },
      { id:"ELON_MUSK", name:"Elon Musk", address:"Austin, TX", notes:"Major Trump supporter.", lat:30.2672, lng:-97.7431 },
      { id:"MARK_ZUCKERBERG", name:"Mark Zuckerberg", address:"Menlo Park, CA", notes:"Major Trump supporter.", lat:37.4521, lng:-122.1819 },
      { id:"VIVEK_RAMASWAMY", name:"Vivek Ramaswamy", address:"Columbus, OH", notes:"Major Trump supporter.", lat:39.9612, lng:-82.9988 },
      { id:"ALPINE_GLOBAL", name:"Alpine Global Management, LLC", address:"140 Broadway, 38th Fl, New York, NY 10005", notes:"Owns several companies with links to Trump and allies.", lat:40.7097, lng:-74.0113 },
      { id:"TETHER", name:"Tether", address:"Road Town, BVI", notes:"Large crypto firm backing Trump endeavors.", lat:18.4286, lng:-64.6185 },
      { id:"MYDA_ADVISORS", name:"MYDA Advisors", address:"1067 Broadway, Ste A, Woodmere, NY 11598", notes:"Owns several Trump-linked companies.", lat:40.6325, lng:-73.7127 },
      { id:"ANSON_FUNDS", name:"Anson Funds Management LP", address:"181 Bay St, Ste 4200, Toronto, ON M5J 2T3, Canada", notes:"Owns several companies with links to Trump and allies.", lat:43.6463, lng:-79.3804 },
      { id:"AROSA_CAPITAL", name:"Arosa Capital Management LP", address:"120 W 45th St, Ste 3700, New York, NY 10036", notes:"Owns several companies with links to Trump and allies.", lat:40.7564, lng:-73.9837 },
      { id:"ERIC_TRUMP", name:"Eric Trump", address:"Palm Beach, FL", notes:"Trump's son; executive/board roles.", lat:26.7153, lng:-80.0534 },
      { id:"BILL_PULTE", name:"Bill Pulte", address:"Naples, FL", notes:"Federal Housing Finance Authority Director.", lat:26.1420, lng:-81.7948 },
      { id:"ROIV", name:"Roivant Sciences (Holder of IMVT)", address:"151 W 42nd St, 15th Fl, New York, NY 10036", notes:"Owns ~57% of IMVT.", lat:40.7563, lng:-73.9865 }
    ],
    links: [
      { investor_id:"GHISALLO", company_id:"NG", units:"1,741,510", instrument:"Shares" },
      { investor_id:"BALYASNY", company_id:"NG", units:"585,351", instrument:"Shares" },
      { investor_id:"PAULSON", company_id:"NG", units:"27,238,061", instrument:"Shares" },

      { investor_id:"AEI", company_id:"RDW", units:"85,496,745", instrument:"Shares" },
      { investor_id:"HUDSONBAY", company_id:"RDW", units:"131,252", instrument:"Shares" },
      { investor_id:"HOODRIVER", company_id:"RDW", units:"2,221,219", instrument:"Shares" },
      { investor_id:"PETER_CANNITO", company_id:"RDW", units:"494,573", instrument:"Shares" },

      { investor_id:"HOODRIVER", company_id:"QXO", units:"8,302,495", instrument:"Shares" },
      { investor_id:"GHISALLO", company_id:"QXO", units:"2,000,000", instrument:"Shares" },
      { investor_id:"BALYASNY", company_id:"QXO", units:"5,668,824", instrument:"Shares" },
      { investor_id:"CANTOR", company_id:"QXO", units:"70,928", instrument:"Shares" },
      { investor_id:"AFFINITY", company_id:"QXO", units:"32,671,542", instrument:"Shares" },

      { investor_id:"ICE", company_id:"BKKT", units:"21,550,595", instrument:"Shares" },
      { investor_id:"CITADEL", company_id:"BKKT", units:"1,319,162", instrument:"Shares" },
      { investor_id:"KELLY_LOEFFLER", company_id:"BKKT", units:"Unknown", instrument:"Shares" },

      { investor_id:"CANTOR", company_id:"WOLF", units:"32,494", instrument:"Shares" },
      { investor_id:"BALYASNY", company_id:"WOLF", units:"67,270,000", instrument:"Note" },

      { investor_id:"CITADEL", company_id:"ALTS", units:"73,677", instrument:"Shares" },
      { investor_id:"JANE_STREET", company_id:"ALTS", units:"10,061,351", instrument:"Shares" },
      { investor_id:"ZACH_WITIKOFF", company_id:"ALTS", units:"Unknown", instrument:"Shares" },

      { investor_id:"DONALD_TRUMP_JR", company_id:"PSQH", units:"697,403", instrument:"Shares" },
      { investor_id:"KELLY_LOEFFLER", company_id:"PSQH", units:"Unknown", instrument:"Shares" },

      { investor_id:"PETER_THIEL", company_id:"PLTR", units:"70,900,000", instrument:"Shares" },

      { investor_id:"ELON_MUSK", company_id:"TSLA", units:"412,600,000", instrument:"Shares" },

      { investor_id:"MARK_ZUCKERBERG", company_id:"META", units:"346,000,000", instrument:"Shares" },

      { investor_id:"BALYASNY", company_id:"ROIV", units:"969,979", instrument:"Shares" },
      { investor_id:"CANTOR", company_id:"ROIV", units:"350,001", instrument:"Shares" },
      { investor_id:"VIVEK_RAMASWAMY", company_id:"ROIV", units:"37,284,108", instrument:"Shares" },

      { investor_id:"BALYASNY", company_id:"IMVT", units:"197,569", instrument:"Shares" },
      { investor_id:"ROIV", company_id:"IMVT", units:"96,650,341", instrument:"Shares" },
      { investor_id:"ALPINE_GLOBAL", company_id:"IMVT", units:"2,626,692", instrument:"Shares" },

      { investor_id:"VIVEK_RAMASWAMY", company_id:"BZFD", units:"3,129,797", instrument:"Shares" },

      { investor_id:"CANTOR", company_id:"RUM", units:"9,333,817", instrument:"Shares" },
      { investor_id:"TETHER", company_id:"RUM", units:"103,333,333", instrument:"Shares" },
      { investor_id:"MYDA_ADVISORS", company_id:"RUM", units:"180,000", instrument:"Calls" },

      { investor_id:"JANE_STREET", company_id:"DJT_DWAC", units:"13,822,035", instrument:"Shares" },
      { investor_id:"ALPINE_GLOBAL", company_id:"DJT_DWAC", units:"1,876,604", instrument:"Shares" },
      { investor_id:"CANTOR", company_id:"DJT_DWAC", units:"1,839,039", instrument:"Shares" },
      { investor_id:"HUDSONBAY", company_id:"DJT_DWAC", units:"1,360,808", instrument:"Shares" },
      { investor_id:"ANSON_FUNDS", company_id:"DJT_DWAC", units:"500,001", instrument:"Shares" },
      { investor_id:"BALYASNY", company_id:"DJT_DWAC", units:"244,162", instrument:"Shares" },

      { investor_id:"DONALD_TRUMP_JR", company_id:"UMAC", units:"331,580", instrument:"Shares" },
      { investor_id:"MYDA_ADVISORS", company_id:"UMAC", units:"80,000", instrument:"Shares" },

      { investor_id:"AROSA_CAPITAL", company_id:"HOND", units:"560,000", instrument:"Shares" },
      { investor_id:"BALYASNY", company_id:"HOND", units:"544,894", instrument:"Shares" },
      { investor_id:"CANTOR", company_id:"HOND", units:"466,287", instrument:"Shares" },
      { investor_id:"MYDA_ADVISORS", company_id:"HOND", units:"300,000", instrument:"Shares" },

      { investor_id:"BALYASNY", company_id:"CEPO_BSTR", units:"220,409", instrument:"Shares" },
      { investor_id:"ALPINE_GLOBAL", company_id:"CEPO_BSTR", units:"173,560", instrument:"Shares" },

      { investor_id:"ERIC_TRUMP", company_id:"ABTC", units:"90,858,814", instrument:"Shares" },
      { investor_id:"DONALD_TRUMP_JR", company_id:"ABTC", units:"90,858,814", instrument:"Shares" },

      { investor_id:"BALYASNY", company_id:"PHM", units:"807,129", instrument:"Shares" },
      { investor_id:"BILL_PULTE", company_id:"PHM", units:"32,338,034", instrument:"Shares" }
    ],
    landmarks: [
      { id:"MAL", name:"Mar-a-Lago", type:"triangle", lat:26.6773, lng:-80.0395 },
      { id:"WH",  name:"The White House", type:"star", lat:38.8977, lng:-77.0365 }
    ]
  };
  // ----------------------------------------------------------------------

  document.addEventListener('DOMContentLoaded', async () => {
    const errBox = document.getElementById('err');
    const okBox  = document.getElementById('ok');
    function showErr(msg){ errBox.textContent = msg; errBox.style.display='block'; }
    function showOk(msg){ okBox.textContent = msg; okBox.style.display='block'; setTimeout(()=>okBox.style.display='none', 3000); }

    // Base map centered on U.S.
    const map = L.map('map', { worldCopyJump:true }).setView([37.8, -96], 4);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom:19, attribution:'&copy; OpenStreetMap contributors'
    }).addTo(map);

    const companyLayer  = L.layerGroup().addTo(map);
    const investorLayer = L.layerGroup().addTo(map);
    const linkLayer     = L.layerGroup().addTo(map);
    const landmarkLayer = L.layerGroup().addTo(map);
    const markersById   = { company:{}, investor:{} };

    // Pull embedded data (no fetch / no geocoding)
    const companies = DATA.companies || [];
    const investors = DATA.investors || [];
    const links     = DATA.links     || [];
    const landmarks = DATA.landmarks || [];
    let focusedIndex = 0;

    // Build markers (with small deterministic jitter to reduce overlap)
    companyLayer.clearLayers(); investorLayer.clearLayers(); linkLayer.clearLayers(); landmarkLayer.clearLayers();
    markersById.company={}; markersById.investor={};

    companies.forEach(c=>{
      if (c.lat==null || c.lng==null) return;
      const [jLat,jLng] = jitterLatLng(c.lat,c.lng,150,`C_${c.id}`);
      const m=L.circleMarker([jLat,jLng],{
        radius:14,color:'white',weight:1.5,fillColor:getVar('--blue'),fillOpacity:.95
      }).bindPopup(companyPopup(c));
      m.addTo(companyLayer); markersById.company[c.id]=m;
    });
    investors.forEach(i=>{
      if (i.lat==null || i.lng==null) return;
      const [jLat,jLng] = jitterLatLng(i.lat,i.lng,150,`I_${i.id}`);
      const m=L.circleMarker([jLat,jLng],{
        radius:9,color:'white',weight:1,fillColor:getVar('--red'),fillOpacity:.95
      }).bindPopup(investorPopup(i));
      m.addTo(investorLayer); markersById.investor[i.id]=m;
    });

    landmarks.forEach(l=>{
      const icon=shapeIcon(l.type, l.type==='triangle'?'#f97316':'#fbbf24');
      L.marker([l.lat,l.lng],{icon}).bindPopup(landmarkPopup(l)).addTo(landmarkLayer);
    });

    // Populate selector
    const sel=document.getElementById('companySelect');
    sel.innerHTML = companies.map((c,i)=>`<option value="${i}">${escapeHTML(c.ticker||c.id)} — ${escapeHTML(c.name||'')}</option>`).join('');

    // Prevent the select (inside <summary>) from toggling the details element
    const panelToggle = document.getElementById('panelToggle');
    sel.addEventListener('mousedown', e => e.stopPropagation());
    sel.addEventListener('click', e => e.stopPropagation());

    sel.addEventListener('change', e=>{ focusedIndex=+e.target.value; focusCompany(); });
    document.getElementById('prevBtn').onclick=()=>{ focusedIndex=(focusedIndex-1+companies.length)%companies.length; sel.value=focusedIndex; focusCompany(); };
    document.getElementById('nextBtn').onclick=()=>{ focusedIndex=(focusedIndex+1)%companies.length; sel.value=focusedIndex; focusCompany(); };
    document.getElementById('showAllLinks').addEventListener('change', ()=>focusCompany());

    // Fit to all pins at first load so you see everything, then focus the first company
    const __fitAllOnce = () => {
      const all = [...Object.values(markersById.company), ...Object.values(markersById.investor)];
      if (all.length) {
        const group = L.featureGroup(all);
        try { map.fitBounds(group.getBounds().pad(0.2), { animate:false }); } catch (_) {}
      }
    };
    __fitAllOnce();

    // Recompute edge-tangent arcs on zoom, but don't refit bounds each time
    map.on('zoomend', () => focusCompany(false));

    // Stats box so you can confirm load
    function countWithCoords(arr){ return arr.filter(x=>x.lat!=null && x.lng!=null).length; }
    document.getElementById('stats').innerHTML =
      `<b>Loaded:</b> ${companies.length} companies (${countWithCoords(companies)} pinned), ` +
      `${investors.length} investors (${countWithCoords(investors)} pinned), ${links.length} links.`;

    // Helper to toggle marker visibility without removing them
    function setCircleVisibility(marker, visible, isCompany=false){
      if (!marker) return;
      marker.setStyle({
        opacity: visible ? 1 : 0,
        fillOpacity: visible ? (isCompany ? 1 : 0.95) : 0
      });
      const el = marker._path;
      if (el) el.style.pointerEvents = visible ? 'auto' : 'none';
    }

    focusCompany();
    showOk('Data loaded ✓');

    // ---- functions
    function focusCompany(fit=true){
      linkLayer.clearLayers();
      const c=companies[focusedIndex]; if(!c){ showErr('No companies loaded.'); return; }

      // sizes/opacity reset, then bump focused
      Object.values(markersById.company).forEach(m=>m.setStyle({radius:14,fillOpacity:.95}));
      const cm=markersById.company[c.id]; if(cm){ cm.setStyle({radius:18,fillOpacity:1}); try{cm.bringToFront();}catch{} }

      const showAll=document.getElementById('showAllLinks').checked;
      const subset= showAll ? links : links.filter(l=>l.company_id===c.id);

      // Hide unrelated pins when Show All is OFF
      const relatedInvestorIds = new Set(links.filter(l=>l.company_id===c.id).map(l=>l.investor_id));

      Object.entries(markersById.company).forEach(([cid, m])=>{
        const visible = showAll || cid === c.id;
        setCircleVisibility(m, visible, true);
      });

      Object.entries(markersById.investor).forEach(([iid, m])=>{
        const visible = showAll || relatedInvestorIds.has(iid);
        setCircleVisibility(m, visible, false);
      });

      // Draw arcs for the chosen subset using edge-to-edge endpoints
      const bounds=L.latLngBounds([]);
      subset.forEach(lk=>{
        const im=markersById.investor[lk.investor_id];
        const cmk=markersById.company[lk.company_id];
        if(!im||!cmk) return;
        const [aEdge, bEdge] = edgeEndpoints(im, cmk);
        L.polyline(arcPoints([aEdge.lat,aEdge.lng],[bEdge.lat,bEdge.lng],0.25),{
          color:getVar('--link'), weight:6, opacity:.9
        }).bindPopup(linkPopup(lk)).addTo(linkLayer);
        bounds.extend(aEdge); bounds.extend(bEdge);
      });

      // Always include the focused company so it's centered even with 0 arcs
      if (cm) bounds.extend(cm.getLatLng());
      if (fit && bounds.isValid()) map.fitBounds(bounds.pad(0.2), { animate:false });

      document.getElementById('companyMeta').innerHTML = companyMetaHTML(c, subset, investors);
    }

    function companyPopup(c){
      const lines=[];
      if(c.ticker) lines.push(`<div><strong>Ticker:</strong> ${escapeHTML(c.ticker)}</div>`);
      if(c.desc) lines.push(`<div><strong>Desc:</strong> ${escapeHTML(c.desc)}</div>`);
      if(c.address) lines.push(`<div><strong>Address:</strong> ${escapeHTML(c.address)}</div>`);
      if(c.qpq) lines.push(`<div><strong>Potential QPQ:</strong> ${escapeHTML(c.qpq)}</div>`);
      return `<div><h3 style="margin:0 0 6px;font-size:1.05rem;">${escapeHTML(c.name||'Company')}</h3>${lines.join('')}</div>`;
    }
    function investorPopup(i){
      const lines=[];
      if(i.address) lines.push(`<div><strong>Address:</strong> ${escapeHTML(i.address)}</div>`);
      if(i.notes)   lines.push(`<div><strong>Connection:</strong> ${escapeHTML(i.notes)}</div>`);
      return `<div><h3 style="margin:0 0 6px;font-size:1.05rem;">${escapeHTML(i.name||'Investor')}</h3>${lines.join('')}</div>`;
    }
    function linkPopup(lk){
      const inv=DATA.investors.find(x=>x.id===lk.investor_id);
      const cmp=DATA.companies.find(x=>x.id===lk.company_id);
      const amt= lk.units!=null ? `<div><strong>Amount:</strong> ${escapeHTML(String(lk.units))} ${escapeHTML(lk.instrument||'')}</div>` : '';
      return `<div><div><strong>Investor:</strong> ${escapeHTML(inv?.name||lk.investor_id)}</div>
                  <div><strong>Company:</strong> ${escapeHTML(cmp?.name||lk.company_id)}</div>${amt}</div>`;
    }
    function companyMetaHTML(c, subsetLinks, allInvestors){
      const invNames = subsetLinks
        .filter(l=>l.company_id===c.id)
        .map(l=> allInvestors.find(i=>i.id===l.investor_id)?.name || l.investor_id);
      return `
        <div><strong>${escapeHTML(c.name||'Company')}</strong>${c.ticker?` (<code class="inline">${escapeHTML(c.ticker)}</code>)`:''}</div>
        ${c.desc?`<div>${escapeHTML(c.desc)}</div>`:''}
        ${c.address?`<div style="opacity:.85">${escapeHTML(c.address)}</div>`:''}
        <div style="margin-top:6px"><strong>Linked investors:</strong> ${invNames.length?escapeHTML(invNames.join(', ')):'None yet'}</div>
      `;
    }
    function landmarkPopup(l){
      return `<div><strong>${escapeHTML(l.name||'Landmark')}</strong></div>`;
    }
    function shapeIcon(type,fillColor){
      const tri=`<svg class="svg-icon" width="28" height="28" viewBox="0 0 28 28" xmlns="http://www.w3.org/2000/svg"><polygon points="14,2 26,26 2,26" fill="${fillColor}" stroke="white" stroke-width="1.5"/></svg>`;
      const star=`<svg class="svg-icon" width="28" height="28" viewBox="0 0 28 28" xmlns="http://www.w3.org/2000/svg"><polygon points="14,2 17.5,10.5 26,11 19,16.5 21,24.5 14,20 7,24.5 9,16.5 2,11 10.5,10.5" fill="${fillColor}" stroke="white" stroke-width="1.5"/></svg>`;
      return L.divIcon({ html:(type==='triangle'?tri:star), className:'custom-shape', iconSize:[28,28], iconAnchor:[14,14] });
    }

    // Small deterministic jitter (meters) to separate overlapping markers
    function jitterLatLng(lat, lng, meters=200, seedStr='') {
      let seed = 0; for (let i=0;i<seedStr.length;i++) seed = (seed*31 + seedStr.charCodeAt(i))>>>0;
      function rand(){ seed = (1664525*seed + 1013904223)>>>0; return (seed>>>0)/4294967296; }
      const angle = rand()*2*Math.PI;
      const r = rand()*meters;
      const dLat = (r * Math.sin(angle)) / 111320;
      const dLng = (r * Math.cos(angle)) / (111320 * Math.cos(lat*Math.PI/180));
      return [lat + dLat, lng + dLng];
    }

    // ---- NEW: compute endpoints at the circle edges in screen space
    function edgeEndpoints(m1, m2){
      const p1 = map.latLngToLayerPoint(m1.getLatLng());
      const p2 = map.latLngToLayerPoint(m2.getLatLng());
      const dist = p1.distanceTo(p2);
      if (!dist) return [m1.getLatLng(), m2.getLatLng()];

      const dx = (p2.x - p1.x) / dist, dy = (p2.y - p1.y) / dist;
      const r1 = (m1.getRadius?.() ?? m1.options.radius ?? 0) + ((m1.options.weight||0)/2);
      const r2 = (m2.getRadius?.() ?? m2.options.radius ?? 0) + ((m2.options.weight||0)/2);

      const p1e = L.point(p1.x + dx * r1, p1.y + dy * r1);
      const p2e = L.point(p2.x - dx * r2, p2.y - dy * r2);

      return [ map.layerPointToLatLng(p1e), map.layerPointToLatLng(p2e) ];
    }

    // Quadratic bezier for arcs
    function arcPoints(a,b,strength=0.25,segments=64){
      const [lat1,lng1]=a,[lat2,lng2]=b;
      const dx=lng2-lng1, dy=lat2-lat1, mx=(lat1+lat2)/2, my=(lng1+lng2)/2;
      let nx=-dy, ny=dx; const norm=Math.hypot(nx,ny)||1; nx/=norm; ny/=norm;
      const k=strength*Math.hypot(dx,dy), cx=my+ny*k, cy=mx+nx*k, pts=[];
      for(let t=0;t<=1.00001;t+=1/segments){
        const lng=(1-t)*(1-t)*lng1 + 2*(1-t)*t*cx + t*t*lng2;
        const lat=(1-t)*(1-t)*lat1 + 2*(1-t)*t*cy + t*t*lat2;
        pts.push([lat,lng]);
      }
      return pts;
    }
    function escapeHTML(s=''){ return String(s).replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;', "'":'&#39;' }[m])) }
    function getVar(name){ return getComputedStyle(document.documentElement).getPropertyValue(name).trim(); }
  });
  </script>
</body>
</html>
