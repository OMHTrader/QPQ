<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Investor ↔ Company Map</title>

  <!-- Leaflet (no SRI so it won’t be blocked) -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    :root{ --bg:#0f172a; --panel:#111827cc; --text:#e5e7eb; --accent:#60a5fa;
           --blue:#3b82f6; --red:#ef4444; --link:#f59e0b; }
    html,body{height:100%;margin:0}
    body{
      background:var(--bg); color:var(--text);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,Helvetica Neue,Arial;
      font-size:20px; line-height:1.45;
    }
    #map{height:100vh;width:100%}

    .banner{position:fixed;left:12px;top:12px;z-index:1100;
      background:#b91c1ccc;color:white;border:1px solid #7f1d1d;border-radius:10px;
      padding:8px 12px;display:none;max-width:60ch}
    .ok{background:#065f4677;border-color:#065f46;display:none}

    .control-panel{ position:fixed; z-index:1000; top:16px; right:12px;
      background:var(--panel); backdrop-filter:blur(6px);
      border:1px solid #1f2937; border-radius:16px; padding:12px 14px; min-width:340px;
      box-shadow:0 8px 24px rgba(0,0,0,.35); }
    .control-panel h2{font-size:1rem; margin:0 0 8px; font-weight:700}
    .row{display:flex; align-items:center; gap:10px; margin:8px 0}
    .row button,.row select{ padding:8px 12px; border-radius:10px; border:1px solid #374151;
      background:#0b1220; color:var(--text); font-size:.95rem; cursor:pointer; }
    .row label{font-size:.95rem; opacity:.9}
    .footnote{font-size:.85rem; opacity:.75; margin-top:8px}
    .legend{ position:fixed; z-index:1000; bottom:12px; left:12px;
      background:var(--panel); border:1px solid #1f2937; border-radius:12px; padding:10px 12px; font-size:.95rem; }
    .legend .swatch{display:inline-block; width:12px; height:12px; border-radius:50%; margin-right:6px}
    .legend .item{margin-right:12px; white-space:nowrap}
    .leaflet-container{background:#0b1020}
    .leaflet-control-attribution{background:rgba(17,24,39,.6); color:#cbd5e1; font-size:.8rem}
    .leaflet-popup-content{color:#0b1220; font-size:.95rem}
    a{color:var(--accent)}
    .svg-icon{filter:drop-shadow(0 2px 4px rgba(0,0,0,.6))}
  </style>
</head>
<body>
  <div id="err" class="banner"></div>
  <div id="ok" class="banner ok"></div>

  <div class="control-panel" id="controls">
    <h2>Company Focus</h2>
    <div class="row">
      <button id="prevBtn" title="Previous company">◀</button>
      <select id="companySelect" aria-label="Select company"></select>
      <button id="nextBtn" title="Next company">▶</button>
    </div>
    <div class="row">
      <label><input type="checkbox" id="showAllLinks" /> Show all arcs</label>
    </div>
    <div id="stats" style="font-size:.9rem;opacity:.9"></div>
    <div id="companyMeta" style="font-size:.95rem; line-height:1.5; opacity:.95;"></div>
    <div class="footnote">Data file: <code>data/graph.json</code></div>
  </div>

  <div class="legend">
    <span class="item"><span class="swatch" style="background:var(--blue)"></span>Company</span>
    <span class="item"><span class="swatch" style="background:var(--red)"></span>Investor</span>
    <span class="item">▲ Mar-a-Lago</span>
    <span class="item">★ White House</span>
  </div>

  <div id="map"></div>

  <script>
  document.addEventListener('DOMContentLoaded', async () => {
    const errBox = document.getElementById('err');
    const okBox  = document.getElementById('ok');
    function showErr(msg){ errBox.textContent = msg; errBox.style.display='block'; }
    function showOk(msg){ okBox.textContent = msg; okBox.style.display='block'; setTimeout(()=>okBox.style.display='none', 4000); }

    // Base map centered on U.S.
    const map = L.map('map', { worldCopyJump:true }).setView([37.8, -96], 4);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom:19, attribution:'&copy; OpenStreetMap contributors'
    }).addTo(map);

    const companyLayer = L.layerGroup().addTo(map);
    const investorLayer = L.layerGroup().addTo(map);
    const linkLayer = L.layerGroup().addTo(map);
    const landmarkLayer = L.layerGroup().addTo(map);
    const markersById = { company:{}, investor:{} };

    let companies=[], investors=[], links=[], landmarks=[];
    let focusedIndex=0;

    // ---- Load data.json
    try{
      const res = await fetch('data/graph.json', { cache:'no-store' });
      if(!res.ok) throw new Error(`HTTP ${res.status} loading data/graph.json`);
      const json = await res.json();
      companies = json.companies||[];
      investors = json.investors||[];
      links     = json.links||[];
      landmarks = json.landmarks||[];
    }catch(e){
      showErr('Could not load data/graph.json. Check the file path/name (case-sensitive) and JSON validity.');
      console.error(e);
      return; // Stop right here if the file didn’t load
    }

    // Geocode anything missing lat/lng
    await geocodeMissing(companies, 'company');
    await geocodeMissing(investors, 'investor');

    // Build markers
    companyLayer.clearLayers(); investorLayer.clearLayers(); linkLayer.clearLayers(); landmarkLayer.clearLayers();
    markersById.company={}; markersById.investor={};

    companies.forEach(c=>{
      if (c.lat==null || c.lng==null) return;
      const m=L.circleMarker([c.lat,c.lng],{
        radius:7,color:'white',weight:1.5,fillColor:getVar('--blue'),fillOpacity:.9
      }).bindPopup(companyPopup(c));
      m.addTo(companyLayer); markersById.company[c.id]=m;
    });
    investors.forEach(i=>{
      if (i.lat==null || i.lng==null) return;
      const m=L.circleMarker([i.lat,i.lng],{
        radius:6,color:'white',weight:1,fillColor:getVar('--red'),fillOpacity:.9
      }).bindPopup(investorPopup(i));
      m.addTo(investorLayer); markersById.investor[i.id]=m;
    });

    landmarks.forEach(l=>{
      const icon=shapeIcon(l.type, l.type==='triangle'?'#f97316':'#fbbf24');
      L.marker([l.lat,l.lng],{icon}).bindPopup(landmarkPopup(l)).addTo(landmarkLayer);
    });

    // Populate selector (always—regardless of coords)
    const sel=document.getElementById('companySelect');
    sel.innerHTML = companies.map((c,i)=>`<option value="${i}">${escapeHTML(c.ticker||c.id)} — ${escapeHTML(c.name||'')}</option>`).join('');
    sel.addEventListener('change', e=>{ focusedIndex=+e.target.value; focusCompany(); });
    document.getElementById('prevBtn').onclick=()=>{ focusedIndex=(focusedIndex-1+companies.length)%companies.length; sel.value=focusedIndex; focusCompany(); };
    document.getElementById('nextBtn').onclick=()=>{ focusedIndex=(focusedIndex+1)%companies.length; sel.value=focusedIndex; focusCompany(); };
    document.getElementById('showAllLinks').addEventListener('change', ()=>focusCompany());

    // Stats box so you can confirm load
    function countWithCoords(arr){ return arr.filter(x=>x.lat!=null && x.lng!=null).length; }
    document.getElementById('stats').innerHTML =
      `<b>Loaded:</b> ${companies.length} companies (${countWithCoords(companies)} pinned), ` +
      `${investors.length} investors (${countWithCoords(investors)} pinned), ${links.length} links.`;

    focusCompany();
    showOk('Data loaded ✓');

    // ---- functions
    function focusCompany(){
      linkLayer.clearLayers();
      const c=companies[focusedIndex]; if(!c){ showErr('No companies loaded.'); return; }

      Object.values(markersById.company).forEach(m=>m.setStyle({radius:7,fillOpacity:.9}));
      const cm=markersById.company[c.id]; if(cm){ cm.setStyle({radius:9,fillOpacity:1}); try{cm.bringToFront();}catch{} }

      const showAll=document.getElementById('showAllLinks').checked;
      const subset= showAll ? links : links.filter(l=>l.company_id===c.id);

      let drawn=0;
      subset.forEach(lk=>{
        const im=markersById.investor[lk.investor_id];
        const cmk=markersById.company[lk.company_id];
        if(!im||!cmk) return;
        const a=im.getLatLng(), b=cmk.getLatLng();
        L.polyline(arcPoints([a.lat,a.lng],[b.lat,b.lng],0.25),{
          color:getVar('--link'), weight:2, opacity:.9
        }).bindPopup(linkPopup(lk)).addTo(linkLayer);
        drawn++;
      });

      document.getElementById('companyMeta').innerHTML = companyMetaHTML(c) +
        (drawn?``:`<div style="opacity:.8;margin-top:6px"><em>No arcs for this company yet (missing coords?).</em></div>`);
    }

    async function geocodeMissing(arr, label){
      const cache=JSON.parse(localStorage.getItem('geocodeCache')||'{}');
      let hits=0, misses=0;
      for (const obj of arr){
        if (obj && (obj.lat==null || obj.lng==null)){
          const q=obj.address||obj.name; if(!q) { misses++; continue; }
          if(!cache[q]){
            try{
              const url=`https://nominatim.openstreetmap.org/search?format=json&limit=1&q=${encodeURIComponent(q)}`;
              const r=await fetch(url,{headers:{'Accept-Language':'en'}});
              const d=await r.json();
              if(d && d[0]) cache[q]={lat:+d[0].lat,lng:+d[0].lon};
              await new Promise(r=>setTimeout(r,350)); // be gentle
            }catch(e){ console.warn('Geocode fail:', q, e); }
          }
          if(cache[q]){ obj.lat=cache[q].lat; obj.lng=cache[q].lng; hits++; } else { misses++; }
        }
      }
      localStorage.setItem('geocodeCache', JSON.stringify(cache));
      console.log(`${label}: geocoded ${hits}, missed ${misses}`);
    }

    function companyPopup(c){
      const lines=[];
      if(c.ticker) lines.push(`<div><strong>Ticker:</strong> ${escapeHTML(c.ticker)}</div>`);
      if(c.desc) lines.push(`<div><strong>Desc:</strong> ${escapeHTML(c.desc)}</div>`);
      if(c.address) lines.push(`<div><strong>Address:</strong> ${escapeHTML(c.address)}</div>`);
      if(c.long_short) lines.push(`<div><strong>Position:</strong> ${escapeHTML(c.long_short)}</div>`);
      if(c["Potential QPQ"] || c.why) lines.push(`<div><strong>Potential QPQ:</strong> ${escapeHTML(c["Potential QPQ"]||c.why)}</div>`);
      return `<div><h3 style="margin:0 0 6px;font-size:1.05rem;">${escapeHTML(c.name||'Company')}</h3>${lines.join('')}</div>`;
    }
    function investorPopup(i){
      const lines=[];
      if(i.address) lines.push(`<div><strong>Address:</strong> ${escapeHTML(i.address)}</div>`);
      if(i.notes)   lines.push(`<div><strong>Connection:</strong> ${escapeHTML(i.notes)}</div>`);
      return `<div><h3 style="margin:0 0 6px;font-size:1.05rem;">${escapeHTML(i.name||'Investor')}</h3>${lines.join('')}</div>`;
    }
    function linkPopup(lk){
      const inv=investors.find(x=>x.id===lk.investor_id);
      const cmp=companies.find(x=>x.id===lk.company_id);
      const amt= lk.units!=null ? `<div><strong>Amount:</strong> ${escapeHTML(String(lk.units))} ${escapeHTML(lk.instrument||'')}</div>` : '';
      return `<div><div><strong>Investor:</strong> ${escapeHTML(inv?.name||lk.investor_id)}</div>
                  <div><strong>Company:</strong> ${escapeHTML(cmp?.name||lk.company_id)}</div>${amt}</div>`;
    }
    function shapeIcon(type,fillColor){
      const tri=`<svg class="svg-icon" width="28" height="28" viewBox="0 0 28 28" xmlns="http://www.w3.org/2000/svg"><polygon points="14,2 26,26 2,26" fill="${fillColor}" stroke="white" stroke-width="1.5"/></svg>`;
      const star=`<svg class="svg-icon" width="28" height="28" viewBox="0 0 28 28" xmlns="http://www.w3.org/2000/svg"><polygon points="14,2 17.5,10.5 26,11 19,16.5 21,24.5 14,20 7,24.5 9,16.5 2,11 10.5,10.5" fill="${fillColor}" stroke="white" stroke-width="1.5"/></svg>`;
      return L.divIcon({ html:(type==='triangle'?tri:star), className:'custom-shape', iconSize:[28,28], iconAnchor:[14,14] });
    }
    function arcPoints(a,b,strength=0.25,segments=64){
      const [lat1,lng1]=a,[lat2,lng2]=b;
      const dx=lng2-lng1, dy=lat2-lat1, mx=(lat1+lat2)/2, my=(lng1+lng2)/2;
      let nx=-dy, ny=dx; const norm=Math.hypot(nx,ny)||1; nx/=norm; ny/=norm;
      const k=strength*Math.hypot(dx,dy), cx=my+ny*k, cy=mx+nx*k, pts=[];
      for(let t=0;t<=1.00001;t+=1/segments){
        const lng=(1-t)*(1-t)*lng1 + 2*(1-t)*t*cx + t*t*lng2;
        const lat=(1-t)*(1-t)*lat1 + 2*(1-t)*t*cy + t*t*lat2;
        pts.push([lat,lng]);
      }
      return pts;
    }
    function escapeHTML(s=''){ return String(s).replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;', "'":'&#39;' }[m])) }
    function getVar(name){ return getComputedStyle(document.documentElement).getPropertyValue(name).trim(); }
  });
  </script>
</body>
</html>
